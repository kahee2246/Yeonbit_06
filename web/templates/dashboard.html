<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Discord Bot ëŒ€ì‹œë³´ë“œ</title>

    <!-- Tailwind CSS -->
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <!-- Axios -->
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
</head>
<body class="bg-gray-900 text-white">
    <div class="container mx-auto p-6">
        <h1 class="text-3xl font-bold mb-8 text-center">ğŸ¤– Discord Auto Bot</h1>
        
        <!-- ìƒíƒœ ì¹´ë“œ -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
            <div class="bg-gray-800 p-6 rounded-lg">
                <h3 class="text-lg font-semibold mb-2">ë´‡ ìƒíƒœ</h3>
                <p class="text-2xl" id="bot-status">
                    {% if is_running %}
                        ğŸŸ¢ ì‹¤í–‰ ì¤‘
                    {% else %}
                        ğŸ”´ ì¤‘ì§€ë¨
                    {% endif %}
                </p>
            </div>
            
            <div class="bg-gray-800 p-6 rounded-lg">
                <h3 class="text-lg font-semibold mb-2">ìë™ ì „ì†¡</h3>
                <p class="text-2xl" id="auto-status">
                    {% if is_enabled %}
                        âœ… í™œì„±í™”
                    {% else %}
                        âŒ ë¹„í™œì„±í™”
                    {% endif %}
                </p>
            </div>
            
            <div class="bg-gray-800 p-6 rounded-lg">
                <h3 class="text-lg font-semibold mb-2">ë‹¤ìŒ ì „ì†¡</h3>
                <p class="text-xl" id="next-send">
                    {% if next_send_time %}
                        {{ next_send_time.strftime('%H:%M:%S') }}
                    {% else %}
                        ì—†ìŒ
                    {% endif %}
                </p>
            </div>
        </div>
        
        <!-- ì œì–´ ë²„íŠ¼ -->
        <div class="flex flex-wrap gap-4 mb-8 justify-center">
            <button onclick="controlBot('start')" class="bg-green-600 hover:bg-green-700 px-6 py-3 rounded-lg">
                ğŸš€ ë´‡ ì‹œì‘
            </button>
            <button onclick="controlBot('stop')" class="bg-red-600 hover:bg-red-700 px-6 py-3 rounded-lg">
                â¹ï¸ ë´‡ ì¤‘ì§€
            </button>
            <button onclick="controlBot('send_now')" class="bg-blue-600 hover:bg-blue-700 px-6 py-3 rounded-lg">
                ğŸ“¨ ì¦‰ì‹œ ì „ì†¡
            </button>
            <a href="/config" class="bg-purple-600 hover:bg-purple-700 px-6 py-3 rounded-lg inline-block">
                âš™ï¸ ì„¤ì •
            </a>
        </div>
        
        <!-- í˜„ì¬ ì„¤ì • -->
        <div class="bg-gray-800 p-6 rounded-lg mb-8">
            <h3 class="text-xl font-semibold mb-4">í˜„ì¬ ì„¤ì •</h3>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <p class="text-gray-400">ì±„ë„ ID:</p>
                    <p class="font-mono">{{ config.channel_id }}</p>
                </div>
                <div>
                    <p class="text-gray-400">ì „ì†¡ ê°„ê²©:</p>
                    <p>{{ config.send_interval }}ì´ˆ ({{ config.send_interval // 60 }}ë¶„)</p>
                </div>
                <div>
                    <p class="text-gray-400">ì´ë¯¸ì§€ ì„¤ì •:</p>
                    <p>
                        {% if config.send_with_image %}
                            {% if config.image_path %}
                                ğŸ–¼ï¸ ì´ë¯¸ì§€ì™€ í•¨ê»˜ ì „ì†¡
                            {% else %}
                                âš ï¸ ì´ë¯¸ì§€ ì—†ìŒ (ì„¤ì • í•„ìš”)
                            {% endif %}
                        {% else %}
                            ğŸ“ í…ìŠ¤íŠ¸ë§Œ ì „ì†¡
                        {% endif %}
                    </p>
                </div>
                <div>
                    <p class="text-gray-400">ë©”ì‹œì§€ ê¸¸ì´:</p>
                    <p>{{ config.message_content|length }}ì</p>
                </div>
            </div>
        </div>
        
        <!-- ë©”ì‹œì§€ ë¯¸ë¦¬ë³´ê¸° -->
        <div class="bg-gray-800 p-6 rounded-lg">
            <h3 class="text-xl font-semibold mb-4">ğŸ“± í˜„ì¬ ë©”ì‹œì§€ ë¯¸ë¦¬ë³´ê¸°</h3>
            <div class="bg-gray-700 p-4 rounded-lg">
                <div class="flex items-start space-x-3">
                    <div class="w-10 h-10 bg-blue-600 rounded-full flex items-center justify-center">
                        ğŸ¤–
                    </div>
                    <div class="flex-1">
                        <div class="font-semibold mb-1">Discord Bot</div>
                        <div class="whitespace-pre-wrap text-sm">{{ config.message_content }}</div>
                        {% if config.send_with_image and config.image_path %}
                        <div class="mt-2">
                            <div class="text-sm text-gray-400 mb-1">ğŸ“· ì²¨ë¶€ëœ ì´ë¯¸ì§€:</div>
                            {% set filename = config.image_path.replace('\\', '/').split('/')[-1] %}
                            <img src="/api/images/{{ filename }}" 
                                 alt="ë´‡ ì´ë¯¸ì§€" class="max-w-xs max-h-48 rounded"
                                 onerror="this.style.display='none'; this.nextElementSibling.style.display='block';">
                            <div class="text-sm text-gray-400" style="display: none;">
                                ì´ë¯¸ì§€ ë¡œë“œ ì‹¤íŒ¨
                            </div>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        // ë´‡ ì œì–´ API í˜¸ì¶œ
        async function controlBot(action) {
            try {
                // ë²„íŠ¼ ë¹„í™œì„±í™”
                const buttons = document.querySelectorAll('button');
                buttons.forEach(btn => btn.disabled = true);
                
                // ì¦‰ì‹œ UI ì—…ë°ì´íŠ¸ (ë‚™ê´€ì  ì—…ë°ì´íŠ¸)
                if (action === 'start') {
                    updateBotStatus('ğŸŸ¡ ì‹œì‘ ì¤‘...', 'text-yellow-400');
                } else if (action === 'stop') {
                    updateBotStatus('ğŸŸ¡ ì¤‘ì§€ ì¤‘...', 'text-yellow-400');
                } else if (action === 'send_now') {
                    updateBotStatus('ğŸ“¤ ì „ì†¡ ì¤‘...', 'text-blue-400');
                }
                
                const res = await axios.post(`/api/bot/${action}`);
                
                // ì„±ê³µ ì‹œ ì¦‰ì‹œ ìƒíƒœ ì—…ë°ì´íŠ¸ ë° ì ì‘í˜• ê°„ê²© ì¬ì„¤ì •
                if (res.data.success) {
                    setTimeout(() => {
                        updateStatus(false).then(() => {
                            setAdaptiveUpdateInterval();
                        });
                    }, 1000);
                }
                
                alert(res.data.message);
                
            } catch (err) {
                alert('ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + err.message);
                // ì˜¤ë¥˜ ì‹œì—ë„ ìƒíƒœ ì—…ë°ì´íŠ¸
                setTimeout(() => updateStatus(false), 1000);
            } finally {
                // ë²„íŠ¼ ë‹¤ì‹œ í™œì„±í™”
                const buttons = document.querySelectorAll('button');
                buttons.forEach(btn => btn.disabled = false);
            }
        }
        
        // ë´‡ ìƒíƒœ UI ì—…ë°ì´íŠ¸ í—¬í¼ í•¨ìˆ˜
        function updateBotStatus(text, className) {
            const botEl = document.getElementById('bot-status');
            botEl.textContent = text;
            botEl.className = `text-2xl ${className}`;
        }

        // ì „ì—­ ë³€ìˆ˜ë¡œ ìƒíƒœ ê´€ë¦¬
        let nextSendTime = null;
        let localTimeOffset = 0;
        let isUpdating = false;
        let statusUpdateInterval = null;
        let countdownInterval = null;

        // ì‹¤ì‹œê°„ ì¹´ìš´íŠ¸ë‹¤ìš´ ì—…ë°ì´íŠ¸ (ë¡œì»¬ì—ì„œë§Œ ê³„ì‚°)
        function updateCountdown() {
            const nextEl = document.getElementById('next-send');
            
            if (nextSendTime) {
                const now = new Date(Date.now() + localTimeOffset);
                const next = new Date(nextSendTime);
                const diff = Math.max(0, Math.floor((next - now) / 1000));
                
                if (diff > 0) {
                    const hours = Math.floor(diff / 3600);
                    const minutes = Math.floor((diff % 3600) / 60);
                    const seconds = diff % 60;
                    
                    if (hours > 0) {
                        nextEl.textContent = `${hours}ì‹œê°„ ${minutes}ë¶„ ${seconds}ì´ˆ í›„`;
                    } else {
                        nextEl.textContent = `${minutes}ë¶„ ${seconds}ì´ˆ í›„`;
                    }
                    nextEl.className = 'text-xl text-blue-400';
                } else {
                    nextEl.textContent = 'ê³§ ì „ì†¡';
                    nextEl.className = 'text-xl text-green-400';
                    // ì „ì†¡ ì‹œê°„ì´ ì§€ë‚˜ë©´ 30ì´ˆ í›„ ìƒíƒœ ì—…ë°ì´íŠ¸
                    setTimeout(() => updateStatus(false), 30000);
                }
            } else {
                nextEl.textContent = 'ì—†ìŒ';
                nextEl.className = 'text-xl text-gray-400';
            }
        }

        // ìƒíƒœ ì—…ë°ì´íŠ¸ í•¨ìˆ˜ (API í˜¸ì¶œ ìµœì†Œí™”)
        async function updateStatus(showLoading = true) {
            if (isUpdating) return; // ì¤‘ë³µ í˜¸ì¶œ ë°©ì§€
            
            try {
                isUpdating = true;
                
                if (showLoading) {
                    updateBotStatus('ğŸ”„ í™•ì¸ ì¤‘...', 'text-blue-400');
                }

                const { data: status } = await axios.get('/api/status');
                const botEl = document.getElementById('bot-status');
                const autoEl = document.getElementById('auto-status');

                // ë´‡ ìƒíƒœ ì—…ë°ì´íŠ¸
                if (status.is_connected && status.is_running) {
                    updateBotStatus('ğŸŸ¢ ì‹¤í–‰ ì¤‘', 'text-green-400');
                } else if (status.is_connected) {
                    updateBotStatus('ğŸŸ¡ ì—°ê²°ë¨', 'text-yellow-400');
                } else {
                    updateBotStatus('ğŸ”´ ì¤‘ì§€ë¨', 'text-red-400');
                }

                // ìë™ ì „ì†¡ ìƒíƒœ
                autoEl.textContent = status.is_enabled ? 'âœ… í™œì„±í™”' : 'âŒ ë¹„í™œì„±í™”';
                autoEl.className = status.is_enabled ? 'text-2xl text-green-400' : 'text-2xl text-red-400';

                // ë‹¤ìŒ ì „ì†¡ ì‹œê°„ ê³„ì‚° ë° ì €ì¥
                if (status.next_send_time && status.is_running && status.is_enabled) {
                    nextSendTime = status.next_send_time;
                    const currentServerTime = status.current_time;
                    localTimeOffset = new Date(currentServerTime) - new Date();
                    
                    // ì¹´ìš´íŠ¸ë‹¤ìš´ ì‹œì‘
                    if (!countdownInterval) {
                        countdownInterval = setInterval(updateCountdown, 1000);
                    }
                } else {
                    nextSendTime = null;
                    // ì¹´ìš´íŠ¸ë‹¤ìš´ ì¤‘ì§€
                    if (countdownInterval) {
                        clearInterval(countdownInterval);
                        countdownInterval = null;
                    }
                }
                
                updateCountdown();
                
            } catch (err) {
                console.error('ìƒíƒœ ì—…ë°ì´íŠ¸ ì˜¤ë¥˜:', err);
                updateBotStatus('âŒ ì—°ê²° ì‹¤íŒ¨', 'text-red-400');
            } finally {
                isUpdating = false;
            }
        }

        // ì ì‘í˜• ì—…ë°ì´íŠ¸ ê°„ê²© ì„¤ì •
        function setAdaptiveUpdateInterval() {
            // ê¸°ì¡´ ì¸í„°ë²Œ í´ë¦¬ì–´
            if (statusUpdateInterval) {
                clearInterval(statusUpdateInterval);
            }
            
            // ë´‡ì´ ì‹¤í–‰ ì¤‘ì´ë©´ 30ì´ˆë§ˆë‹¤, ì•„ë‹ˆë©´ 60ì´ˆë§ˆë‹¤ ì—…ë°ì´íŠ¸
            const isRunning = document.getElementById('bot-status').textContent.includes('ì‹¤í–‰ ì¤‘');
            const interval = isRunning ? 30000 : 60000; // 30ì´ˆ ë˜ëŠ” 60ì´ˆ
            
            statusUpdateInterval = setInterval(() => updateStatus(false), interval);
        }

        // í˜ì´ì§€ í™œì„±í™” ìƒíƒœ ê°ì§€
        function handleVisibilityChange() {
            if (document.hidden) {
                // í˜ì´ì§€ê°€ ë°±ê·¸ë¼ìš´ë“œë¡œ ê°€ë©´ ì—…ë°ì´íŠ¸ ì¤‘ì§€
                if (statusUpdateInterval) {
                    clearInterval(statusUpdateInterval);
                    statusUpdateInterval = null;
                }
                if (countdownInterval) {
                    clearInterval(countdownInterval);
                    countdownInterval = null;
                }
            } else {
                // í˜ì´ì§€ê°€ ë‹¤ì‹œ í™œì„±í™”ë˜ë©´ ì¦‰ì‹œ ìƒíƒœ ì—…ë°ì´íŠ¸ í›„ ì¸í„°ë²Œ ì¬ì‹œì‘
                updateStatus(false).then(() => {
                    setAdaptiveUpdateInterval();
                    if (nextSendTime && !countdownInterval) {
                        countdownInterval = setInterval(updateCountdown, 1000);
                    }
                });
            }
        }

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸°í™”
        document.addEventListener('DOMContentLoaded', function() {
            // ì´ˆê¸° ìƒíƒœ ì—…ë°ì´íŠ¸
            updateStatus(true);
            
            // ì ì‘í˜• ì—…ë°ì´íŠ¸ ê°„ê²© ì„¤ì •
            setTimeout(setAdaptiveUpdateInterval, 2000);
            
            // í˜ì´ì§€ ê°€ì‹œì„± ë³€í™” ê°ì§€
            document.addEventListener('visibilitychange', handleVisibilityChange);
            
            // í˜ì´ì§€ ì–¸ë¡œë“œ ì‹œ ì¸í„°ë²Œ ì •ë¦¬
            window.addEventListener('beforeunload', function() {
                if (statusUpdateInterval) clearInterval(statusUpdateInterval);
                if (countdownInterval) clearInterval(countdownInterval);
            });
        });
    </script>
</body>
</html>
